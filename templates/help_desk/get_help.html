<!--
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #result {
            margin-top: 20px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            font-size: 18px;
            line-height: 1.5;
            background-color: #fff;
        }

        #completedSentences {
            margin-top: 20px;
            padding: 20px;
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            background-color: #f8f9fa;
        }

        #startStopButton {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #startStopButton.recording {
            background-color: #f44336;
        }

        .status {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .error {
            color: #f44336;
            margin-top: 10px;
        }

        .sentence-complete {
            padding: 10px;
            margin: 5px 0;
            background-color: #e8f5e9;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</h1>
        <button id="startStopButton">শুরু করুন</button>
        <p class="status" id="status">রেকর্ড করতে বাটনে ক্লিক করুন</p>
        
        <h3>বর্তমান বক্তব্য</h3>
        <div id="result">আপনার কথা এখানে প্রদর্শিত হবে...</div>
        
        <h3>সম্পূর্ণ হওয়া বাক্যসমূহ</h3>
        <div id="completedSentences">এখানে সম্পূর্ণ হওয়া বাক্যগুলি দেখানো হবে...</div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;

        function initializeSpeechRecognition() {
            if ("webkitSpeechRecognition" in window) {
                recognition = new webkitSpeechRecognition();
                setupRecognition();
            } else {
                showError(
                    "আপনার ব্রাউজারে স্পিচ রেকগনিশন সাপোর্টেড নয়। Chrome ব্রাউজার ব্যবহার করুন।"
                );
            }
        }

        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = "bn-BD";

            let buffer = "";
            let lastProcessedLength = 0;
            const sentenceEndMarkers = ['।', '?', '!', '।।'];
            let silenceTimer = null;
            const SILENCE_THRESHOLD = 500; // 1.5 seconds

            recognition.onstart = function() {
                isRecording = true;
                updateUI();
                buffer = "";
                lastProcessedLength = 0;
            };

            recognition.onend = function() {
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };

            recognition.onresult = function(event) {
                let interimTranscript = "";
                let finalTranscript = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        if (silenceTimer) {
                            clearTimeout(silenceTimer);
                        }
                        silenceTimer = setTimeout(() => {
                            handleSentenceCompletion("silence");
                        }, SILENCE_THRESHOLD);
                    } else {
                        interimTranscript += transcript;
                    }
                }

                buffer = finalTranscript || interimTranscript;
                checkForCompletedSentences(buffer.slice(lastProcessedLength));
                lastProcessedLength = buffer.length;

                document.getElementById("result").textContent = 
                    buffer || "আপনার কথা এখানে প্রদর্শিত হবে...";
            };

            function checkForCompletedSentences(newText) {
                if (sentenceEndMarkers.some(marker => newText.includes(marker))) {
                    handleSentenceCompletion("punctuation");
                }
            }

            function handleSentenceCompletion(reason) {
                const currentText = buffer.trim();
                
                if (currentText) {
                    // Add the completed sentence to the UI
                    console.log(currentText);
                    const completedSentencesDiv = document.getElementById("completedSentences");
                    const sentenceElement = document.createElement("div");
                    sentenceElement.className = "sentence-complete";
                    sentenceElement.textContent = currentText;
                    
                    if (completedSentencesDiv.firstChild) {
                        completedSentencesDiv.insertBefore(sentenceElement, completedSentencesDiv.firstChild);
                    } else {
                        completedSentencesDiv.appendChild(sentenceElement);
                    }

                    // Dispatch custom event
                    const event = new CustomEvent('sentenceComplete', {
                        detail: {
                            text: currentText,
                            reason: reason
                        }
                    });
                    document.dispatchEvent(event);

                    // Clear buffer if silence-based completion
                    if (reason === "silence") {
                        buffer = "";
                        lastProcessedLength = 0;
                    }
                }
            }

            recognition.onerror = function(event) {
                showError("ত্রুটি: " + event.error);
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };
        }

        function toggleRecording() {
            if (!recognition) {
                initializeSpeechRecognition();
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (err) {
                    showError(
                        "রেকর্ডিং শুরু করতে সমস্যা হচ্ছে। পুনরায় চেষ্টা করুন।"
                    );
                }
            }
        }

        function updateUI() {
            const button = document.getElementById("startStopButton");
            const status = document.getElementById("status");

            if (isRecording) {
                button.textContent = "থামান";
                button.classList.add("recording");
                status.textContent = "রেকর্ডিং চলছে...";
            } else {
                button.textContent = "শুরু করুন";
                button.classList.remove("recording");
                status.textContent = "রেকর্ড করতে বাটনে ক্লিক করুন";
            }
        }

        function showError(message) {
            const status = document.getElementById("status");
            status.textContent = message;
            status.classList.add("error");
        }

        // Add event listeners
        document.getElementById("startStopButton").addEventListener("click", toggleRecording);

        // Example of using the sentence completion event
        document.addEventListener('sentenceComplete', (event) => {
            const { text, reason } = event.detail;
            console.log(`Completed sentence detected (${reason}):`, text);
        });

        // Initialize speech recognition
        initializeSpeechRecognition();
    </script>
</body>
</html>




<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #result {
            margin-top: 20px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            font-size: 18px;
            line-height: 1.5;
            background-color: #fff;
        }

        #completedSentences {
            margin-top: 20px;
            padding: 20px;
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            background-color: #f8f9fa;
        }

        #startStopButton {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #startStopButton.recording {
            background-color: #f44336;
        }

        .status {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .error {
            color: #f44336;
            margin-top: 10px;
        }

        .sentence-complete {
            padding: 10px;
            margin: 5px 0;
            background-color: #e8f5e9;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
            transition: all 0.3s ease;
        }

        .error-message {
            color: #f44336;
            font-size: 0.9em;
            margin-left: 10px;
        }

        [data-status='sending'] {
            position: relative;
        }

        [data-status='sending']::after {
            content: '⟳';
            position: absolute;
            right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</h1>
        <button id="startStopButton">শুরু করুন</button>
        <p class="status" id="status">রেকর্ড করতে বাটনে ক্লিক করুন</p>
        
        <h3>বর্তমান বক্তব্য</h3>
        <div id="result">আপনার কথা এখানে প্রদর্শিত হবে...</div>
        
        <h3>সম্পূর্ণ হওয়া বাক্যসমূহ</h3>
        <div id="completedSentences">এখানে সম্পূর্ণ হওয়া বাক্যগুলি দেখানো হবে...</div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;

        function initializeSpeechRecognition() {
            if ("webkitSpeechRecognition" in window) {
                recognition = new webkitSpeechRecognition();
                setupRecognition();
            } else {
                showError(
                    "আপনার ব্রাউজারে স্পিচ রেকগনিশন সাপোর্টেড নয়। Chrome ব্রাউজার ব্যবহার করুন।"
                );
            }
        }

        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = "bn-BD";

            let buffer = "";
            let lastProcessedLength = 0;
            const sentenceEndMarkers = ['।', '?', '!', '।।'];
            let silenceTimer = null;
            const SILENCE_THRESHOLD = 500; // 1.5 seconds

            recognition.onstart = function() {
                isRecording = true;
                updateUI();
                buffer = "";
                lastProcessedLength = 0;
            };

            recognition.onend = function() {
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };

            recognition.onresult = function(event) {
                let interimTranscript = "";
                let finalTranscript = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        if (silenceTimer) {
                            clearTimeout(silenceTimer);
                        }
                        silenceTimer = setTimeout(() => {
                            handleSentenceCompletion("silence");
                        }, SILENCE_THRESHOLD);
                    } else {
                        interimTranscript += transcript;
                    }
                }

                buffer = finalTranscript || interimTranscript;
                checkForCompletedSentences(buffer.slice(lastProcessedLength));
                lastProcessedLength = buffer.length;

                document.getElementById("result").textContent = 
                    buffer || "আপনার কথা এখানে প্রদর্শিত হবে...";
            };

            function checkForCompletedSentences(newText) {
                if (sentenceEndMarkers.some(marker => newText.includes(marker))) {
                    handleSentenceCompletion("punctuation");
                }
            }

            async function handleSentenceCompletion(reason) {
                const currentText = buffer.trim();
                
                if (currentText) {
                    try {
                        // Add the completed sentence to the UI
                        const completedSentencesDiv = document.getElementById("completedSentences");
                        const sentenceElement = document.createElement("div");
                        sentenceElement.className = "sentence-complete";
                        sentenceElement.textContent = currentText;
                        
                        // Add loading indicator
                        sentenceElement.setAttribute('data-status', 'sending');
                        sentenceElement.style.opacity = '0.7';
                        
                        if (completedSentencesDiv.firstChild) {
                            completedSentencesDiv.insertBefore(sentenceElement, completedSentencesDiv.firstChild);
                        } else {
                            completedSentencesDiv.appendChild(sentenceElement);
                        }

                        // Send to backend API
                        const response = await fetch('http://localhost:8000/help_desk_receive/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                // Add any additional headers like authentication tokens if needed
                                // 'Authorization': 'Bearer YOUR_TOKEN'
                            },
                            body: JSON.stringify({
                                text: currentText,
                                timestamp: new Date().toISOString(),
                                reason: reason,
                                language: 'bn-BD'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }else{
                            //console.log(response.agdum);
                            const data = await response.json()
                            console.log(data.agdum)
                        }

                        // Update UI to show success
                        sentenceElement.setAttribute('data-status', 'sent');
                        sentenceElement.style.opacity = '1';
                        sentenceElement.style.borderLeft = '4px solid #4caf50';

                        // Optional: Get response from API
                        //const data = await response.json();
                        //console.log('API Response:', data);
                        //console.log('API Response:', data.agdum);

                    } catch (error) {
                        console.error('Error sending to API:', error);
                        
                        // Update UI to show error
                        sentenceElement.setAttribute('data-status', 'error');
                        sentenceElement.style.borderLeft = '4px solid #f44336';
                        
                        // Optionally show error message
                        const errorSpan = document.createElement('span');
                        errorSpan.className = 'error-message';
                        errorSpan.textContent = ' (পাঠানো ব্যর্থ হয়েছে)';
                        sentenceElement.appendChild(errorSpan);
                    }

                    // Dispatch custom event
                    const event = new CustomEvent('sentenceComplete', {
                        detail: {
                            text: currentText,
                            reason: reason
                        }
                    });
                    document.dispatchEvent(event);

                    // Clear buffer if silence-based completion
                    if (reason === "silence") {
                        buffer = "";
                        lastProcessedLength = 0;
                    }
                }
            }

            recognition.onerror = function(event) {
                showError("ত্রুটি: " + event.error);
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };
        }

        function toggleRecording() {
            if (!recognition) {
                initializeSpeechRecognition();
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (err) {
                    showError(
                        "রেকর্ডিং শুরু করতে সমস্যা হচ্ছে। পুনরায় চেষ্টা করুন।"
                    );
                }
            }
        }

        function updateUI() {
            const button = document.getElementById("startStopButton");
            const status = document.getElementById("status");

            if (isRecording) {
                button.textContent = "থামান";
                button.classList.add("recording");
                status.textContent = "রেকর্ডিং চলছে...";
            } else {
                button.textContent = "শুরু করুন";
                button.classList.remove("recording");
                status.textContent = "রেকর্ড করতে বাটনে ক্লিক করুন";
            }
        }

        function showError(message) {
            const status = document.getElementById("status");
            status.textContent = message;
            status.classList.add("error");
        }

        // Add event listeners
        document.getElementById("startStopButton").addEventListener("click", toggleRecording);

        // Example of using the sentence completion event
        document.addEventListener('sentenceComplete', (event) => {
            const { text, reason } = event.detail;
            console.log(`Completed sentence detected (${reason}):`, text);
        });

        // Initialize speech recognition
        initializeSpeechRecognition();
    </script>
</body>
</html>





<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</title>
    <style>
        /* Previous styles remain the same */
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #result {
            margin-top: 20px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            font-size: 18px;
            line-height: 1.5;
            background-color: #fff;
        }

        #completedSentences {
            margin-top: 20px;
            padding: 20px;
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            background-color: #f8f9fa;
        }

        #startStopButton {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #startStopButton.recording {
            background-color: #f44336;
        }

        .status {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .error {
            color: #f44336;
            margin-top: 10px;
        }

        .sentence-complete {
            padding: 10px;
            margin: 5px 0;
            background-color: #e8f5e9;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .play-button {
            background: none;
            border: none;
            color: #4caf50;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            margin-left: 10px;
        }

        .play-button:hover {
            color: #45a049;
        }

        .error-message {
            color: #f44336;
            font-size: 0.9em;
            margin-left: 10px;
        }

        [data-status='sending'] {
            position: relative;
        }

        [data-status='sending']::after {
            content: '⟳';
            position: absolute;
            right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</h1>
        <button id="startStopButton">শুরু করুন</button>
        <p class="status" id="status">রেকর্ড করতে বাটনে ক্লিক করুন</p>
        
        <h3>বর্তমান বক্তব্য</h3>
        <div id="result">আপনার কথা এখানে প্রদর্শিত হবে...</div>
        
        <h3>সম্পূর্ণ হওয়া বাক্যসমূহ</h3>
        <div id="completedSentences">এখানে সম্পূর্ণ হওয়া বাক্যগুলি দেখানো হবে...</div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;
        const synth = window.speechSynthesis;

        function speak(text) {
            // Cancel any ongoing speech
            synth.cancel();

            // Create a new utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'bn-BD'; // Set language to Bengali
            utterance.rate = 1.0; // Speech rate
            utterance.pitch = 1.0; // Speech pitch

            // Speak the text
            synth.speak(utterance);
        }

        function initializeSpeechRecognition() {
            if ("webkitSpeechRecognition" in window) {
                recognition = new webkitSpeechRecognition();
                setupRecognition();
            } else {
                showError(
                    "আপনার ব্রাউজারে স্পিচ রেকগনিশন সাপোর্টেড নয়। Chrome ব্রাউজার ব্যবহার করুন।"
                );
            }
        }

        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = "bn-BD";

            let buffer = "";
            let lastProcessedLength = 0;
            const sentenceEndMarkers = ['।', '?', '!', '।।'];
            let silenceTimer = null;
            const SILENCE_THRESHOLD = 500;

            recognition.onstart = function() {
                isRecording = true;
                updateUI();
                buffer = "";
                lastProcessedLength = 0;
            };

            recognition.onend = function() {
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };

            recognition.onresult = function(event) {
                let interimTranscript = "";
                let finalTranscript = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        if (silenceTimer) {
                            clearTimeout(silenceTimer);
                        }
                        silenceTimer = setTimeout(() => {
                            handleSentenceCompletion("silence");
                        }, SILENCE_THRESHOLD);
                    } else {
                        interimTranscript += transcript;
                    }
                }

                buffer = finalTranscript || interimTranscript;
                checkForCompletedSentences(buffer.slice(lastProcessedLength));
                lastProcessedLength = buffer.length;

                document.getElementById("result").textContent = 
                    buffer || "আপনার কথা এখানে প্রদর্শিত হবে...";
            };

            function checkForCompletedSentences(newText) {
                if (sentenceEndMarkers.some(marker => newText.includes(marker))) {
                    handleSentenceCompletion("punctuation");
                }
            }

            async function handleSentenceCompletion(reason) {
                const currentText = buffer.trim();
                
                if (currentText) {
                    try {
                        // Create sentence element with content and play button
                        const completedSentencesDiv = document.getElementById("completedSentences");
                        const sentenceElement = document.createElement("div");
                        sentenceElement.className = "sentence-complete";
                        
                        // Create text container
                        const textContainer = document.createElement("div");
                        textContainer.className = "text-content";
                        textContainer.textContent = currentText;
                        
                        // Add loading indicator
                        sentenceElement.setAttribute('data-status', 'sending');
                        sentenceElement.style.opacity = '0.7';
                        
                        // Add elements to sentence container
                        sentenceElement.appendChild(textContainer);
                        
                        if (completedSentencesDiv.firstChild) {
                            completedSentencesDiv.insertBefore(sentenceElement, completedSentencesDiv.firstChild);
                        } else {
                            completedSentencesDiv.appendChild(sentenceElement);
                        }

                        // Send to backend API
                        const response = await fetch('http://localhost:8000/help_desk_receive/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: currentText,
                                timestamp: new Date().toISOString(),
                                reason: reason,
                                language: 'bn-BD'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(data.agdum);

                        

                        // Create and add play button for response
                        const playButton = document.createElement("button");
                        playButton.className = "play-button";
                        playButton.innerHTML = "🔊"; // Speaker emoji
                        playButton.title = "Play response";
                        playButton.onclick = () => speak(data.agdum);
                        sentenceElement.appendChild(playButton);

                        // Automatically speak the response
                        speak(data.agdum);

                        // Update UI to show success
                        sentenceElement.setAttribute('data-status', 'sent');
                        sentenceElement.style.opacity = '1';
                        sentenceElement.style.borderLeft = '4px solid #4caf50';

                    } catch (error) {
                        console.error('Error sending to API:', error);
                        
                        // Update UI to show error
                        sentenceElement.setAttribute('data-status', 'error');
                        sentenceElement.style.borderLeft = '4px solid #f44336';
                        
                        // Show error message
                        const errorSpan = document.createElement('span');
                        errorSpan.className = 'error-message';
                        errorSpan.textContent = ' (পাঠানো ব্যর্থ হয়েছে)';
                        sentenceElement.appendChild(errorSpan);
                    }

                    // Dispatch custom event
                    const event = new CustomEvent('sentenceComplete', {
                        detail: {
                            text: currentText,
                            reason: reason
                        }
                    });
                    document.dispatchEvent(event);

                    // Clear buffer if silence-based completion
                    if (reason === "silence") {
                        buffer = "";
                        lastProcessedLength = 0;
                    }
                }
            }

            recognition.onerror = function(event) {
                showError("ত্রুটি: " + event.error);
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };
        }

        function toggleRecording() {
            if (!recognition) {
                initializeSpeechRecognition();
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (err) {
                    showError(
                        "রেকর্ডিং শুরু করতে সমস্যা হচ্ছে। পুনরায় চেষ্টা করুন।"
                    );
                }
            }
        }

        function updateUI() {
            const button = document.getElementById("startStopButton");
            const status = document.getElementById("status");

            if (isRecording) {
                button.textContent = "থামান";
                button.classList.add("recording");
                status.textContent = "রেকর্ডিং চলছে...";
            } else {
                button.textContent = "শুরু করুন";
                button.classList.remove("recording");
                status.textContent = "রেকর্ড করতে বাটনে ক্লিক করুন";
            }
        }

        function showError(message) {
            const status = document.getElementById("status");
            status.textContent = message;
            status.classList.add("error");
        }

        // Add event listeners
        document.getElementById("startStopButton").addEventListener("click", toggleRecording);

        // Example of using the sentence completion event
        document.addEventListener('sentenceComplete', (event) => {
            const { text, reason } = event.detail;
            console.log(`Completed sentence detected (${reason}):`, text);
        });

        // Initialize speech recognition
        initializeSpeechRecognition();
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #result {
            margin-top: 20px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            font-size: 18px;
            line-height: 1.5;
            background-color: #fff;
        }

        #completedSentences {
            margin-top: 20px;
            padding: 20px;
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            background-color: #f8f9fa;
        }

        #startStopButton {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #startStopButton.recording {
            background-color: #f44336;
        }

        .status {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .error {
            color: #f44336;
            margin-top: 10px;
        }

        .sentence-complete {
            padding: 10px;
            margin: 5px 0;
            background-color: #e8f5e9;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
            transition: all 0.3s ease;
        }

        .sentence-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .text-content {
            flex-grow: 1;
            margin-right: 10px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-button {
            background: none;
            border: none;
            color: #4caf50;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
        }

        .play-button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .status-text {
            font-size: 0.8em;
            color: #666;
        }

        .audio-player {
            width: 200px;
            height: 30px;
            display: none;
        }

        [data-status='sending'] {
            opacity: 0.7;
        }

        [data-status='sending']::after {
            content: '⟳';
            position: absolute;
            right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</h1>
        <button id="startStopButton">শুরু করুন</button>
        <p class="status" id="status">রেকর্ড করতে বাটনে ক্লিক করুন</p>
        
        <h3>বর্তমান বক্তব্য</h3>
        <div id="result">আপনার কথা এখানে প্রদর্শিত হবে...</div>
        
        <h3>সম্পূর্ণ হওয়া বাক্যসমূহ</h3>
        <div id="completedSentences">এখানে সম্পূর্ণ হওয়া বাক্যগুলি দেখানো হবে...</div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;

        function createSpeechElements() {
            const container = document.createElement('div');
            container.className = 'controls';

            const button = document.createElement('button');
            button.className = 'play-button';
            button.innerHTML = '🔊';
            button.title = 'Play response';

            const status = document.createElement('div');
            status.className = 'status-text';
            status.textContent = '';

            const audio = document.createElement('audio');
            audio.className = 'audio-player';
            audio.controls = true;

            container.appendChild(button);
            container.appendChild(status);
            container.appendChild(audio);

            return { container, button, status, audio };
        }

        function setupSpeech(text, speechElements) {
            const { button, status, audio } = speechElements;

            try {
                status.textContent = "Generating speech...";
                button.disabled = true;
                
                // Create URL for Google Translate TTS
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=bn&client=tw-ob&q=${encodeURIComponent(text)}`;
                
                // Set audio source and play
                audio.src = url;
                audio.style.display = "block";
                
                audio.onloadeddata = () => {
                    status.textContent = "Ready to play";
                    button.disabled = false;
                    audio.play();
                };

                audio.onerror = () => {
                    status.textContent = "Error loading audio. Please try again.";
                    button.disabled = false;
                };

                // Add click handler for the play button
                button.onclick = () => {
                    if (audio.paused) {
                        audio.play();
                    } else {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                };

            } catch (error) {
                status.textContent = "Error: " + error.message;
                button.disabled = false;
            }
        }

        function initializeSpeechRecognition() {
            if ("webkitSpeechRecognition" in window) {
                recognition = new webkitSpeechRecognition();
                setupRecognition();
            } else {
                showError(
                    "আপনার ব্রাউজারে স্পিচ রেকগনিশন সাপোর্টেড নয়। Chrome ব্রাউজার ব্যবহার করুন।"
                );
            }
        }

        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = "bn-BD";

            let buffer = "";
            let lastProcessedLength = 0;
            const sentenceEndMarkers = ['।', '?', '!', '।।'];
            let silenceTimer = null;
            const SILENCE_THRESHOLD = 500;

            recognition.onstart = function() {
                isRecording = true;
                updateUI();
                buffer = "";
                lastProcessedLength = 0;
            };

            recognition.onend = function() {
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };

            recognition.onresult = function(event) {
                let interimTranscript = "";
                let finalTranscript = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        if (silenceTimer) {
                            clearTimeout(silenceTimer);
                        }
                        silenceTimer = setTimeout(() => {
                            handleSentenceCompletion("silence");
                        }, SILENCE_THRESHOLD);
                    } else {
                        interimTranscript += transcript;
                    }
                }

                buffer = finalTranscript || interimTranscript;
                checkForCompletedSentences(buffer.slice(lastProcessedLength));
                lastProcessedLength = buffer.length;

                document.getElementById("result").textContent = 
                    buffer || "আপনার কথা এখানে প্রদর্শিত হবে...";
            };

            function checkForCompletedSentences(newText) {
                if (sentenceEndMarkers.some(marker => newText.includes(marker))) {
                    handleSentenceCompletion("punctuation");
                }
            }

            async function handleSentenceCompletion(reason) {
                const currentText = buffer.trim();
                
                if (currentText) {
                    try {
                        // Create sentence element
                        const completedSentencesDiv = document.getElementById("completedSentences");
                        const sentenceElement = document.createElement("div");
                        sentenceElement.className = "sentence-complete";
                        
                        // Create container for text and controls
                        const container = document.createElement("div");
                        container.className = "sentence-container";
                        
                        // Create text content
                        const textContent = document.createElement("div");
                        textContent.className = "text-content";
                        textContent.textContent = currentText;
                        
                        // Create speech controls
                        const speechElements = createSpeechElements();
                        
                        // Add elements to container
                        container.appendChild(textContent);
                        container.appendChild(speechElements.container);
                        sentenceElement.appendChild(container);
                        
                        // Add to DOM
                        if (completedSentencesDiv.firstChild) {
                            completedSentencesDiv.insertBefore(sentenceElement, completedSentencesDiv.firstChild);
                        } else {
                            completedSentencesDiv.appendChild(sentenceElement);
                        }

                        // Send to backend API
                        const response = await fetch('http://localhost:8000/help_desk_receive/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: currentText,
                                timestamp: new Date().toISOString(),
                                reason: reason,
                                language: 'bn-BD'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(data.agdum);

                        // Setup speech for the response
                        setupSpeech(data.agdum, speechElements);

                    } catch (error) {
                        console.error('Error:', error);
                        const errorSpan = document.createElement('span');
                        errorSpan.className = 'error-message';
                        errorSpan.textContent = ' (পাঠানো ব্যর্থ হয়েছে)';
                        sentenceElement.appendChild(errorSpan);
                    }

                    // Clear buffer if silence-based completion
                    if (reason === "silence") {
                        buffer = "";
                        lastProcessedLength = 0;
                    }
                }
            }

            recognition.onerror = function(event) {
                showError("ত্রুটি: " + event.error);
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };
        }

        function toggleRecording() {
            if (!recognition) {
                initializeSpeechRecognition();
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (err) {
                    showError(
                        "রেকর্ডিং শুরু করতে সমস্যা হচ্ছে। পুনরায় চেষ্টা করুন।"
                    );
                }
            }
        }

        function updateUI() {
            const button = document.getElementById("startStopButton");
            const status = document.getElementById("status");

            if (isRecording) {
                button.textContent = "থামান";
                button.classList.add("recording");
                status.textContent = "রেকর্ডিং চলছে...";
            } else {
                button.textContent = "শুরু করুন";
                button.classList.remove("recording");
                status.textContent = "রেকর্ড করতে বাটনে ক্লিক করুন";
            }
        }

        function showError(message) {
            const status = document.getElementById("status");
            status.textContent = message;
            status.classList.add("error");
        }

        // Add event listener for start/stop button
        document.getElementById("startStopButton").addEventListener("click", toggleRecording);

        // Initialize speech recognition
        initializeSpeechRecognition();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #result {
            margin-top: 20px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            font-size: 18px;
            line-height: 1.5;
            background-color: #fff;
        }

        #completedSentences {
            margin-top: 20px;
            padding: 20px;
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            background-color: #f8f9fa;
        }

        #startStopButton {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #startStopButton.recording {
            background-color: #f44336;
        }

        #startStopButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .error {
            color: #f44336;
            margin-top: 10px;
        }

        .sentence-complete {
            padding: 10px;
            margin: 5px 0;
            background-color: #e8f5e9;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
            transition: all 0.3s ease;
        }

        .sentence-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .text-content {
            flex-grow: 1;
            margin-right: 10px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-button {
            background: none;
            border: none;
            color: #4caf50;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
        }

        .play-button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .status-text {
            font-size: 0.8em;
            color: #666;
        }

        .audio-player {
            width: 200px;
            height: 30px;
            display: none;
        }

        [data-status='sending'] {
            opacity: 0.7;
        }

        [data-status='sending']::after {
            content: '⟳';
            position: absolute;
            right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>বাংলা স্পিচ টু টেক্সট - উন্নত সংস্করণ</h1>
        <button id="startStopButton">শুরু করুন</button>
        <p class="status" id="status">রেকর্ড করতে বাটনে ক্লিক করুন</p>
        
        <h3>বর্তমান বক্তব্য</h3>
        <div id="result">আপনার কথা এখানে প্রদর্শিত হবে...</div>
        
        <h3>সম্পূর্ণ হওয়া বাক্যসমূহ</h3>
        <div id="completedSentences">এখানে সম্পূর্ণ হওয়া বাক্যগুলি দেখানো হবে...</div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;
        let isPlaying = false;
        const startStopButton = document.getElementById("startStopButton");

        function createSpeechElements() {
            const container = document.createElement('div');
            container.className = 'controls';

            const button = document.createElement('button');
            button.className = 'play-button';
            button.innerHTML = '🔊';
            button.title = 'Play response';

            const status = document.createElement('div');
            status.className = 'status-text';
            status.textContent = '';

            const audio = document.createElement('audio');
            audio.className = 'audio-player';
            audio.controls = true;

            container.appendChild(button);
            container.appendChild(status);
            container.appendChild(audio);

            return { container, button, status, audio };
        }

        function setupSpeech(text, speechElements) {
            const { button, status, audio } = speechElements;

            try {
                status.textContent = "Generating speech...";
                button.disabled = true;
                
                // Pause recognition before playing
                if (recognition && isRecording) {
                    recognition.stop();
                    isRecording = false;
                    updateUI();
                }

                // Create URL for Google Translate TTS
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=bn&client=tw-ob&q=${encodeURIComponent(text)}`;
                
                // Set audio source and play
                audio.src = url;
                audio.style.display = "block";
                
                audio.onloadeddata = () => {
                    status.textContent = "Ready to play";
                    button.disabled = false;
                    isPlaying = true;
                    startStopButton.disabled = true;
                    recognition.stop();
                    audio.play();
                };

                audio.onended = () => {
                    isPlaying = false;
                    startStopButton.disabled = false;
                    // Resume recognition if it was previously recording
                    if (!isRecording) {
                        toggleRecording();
                    }
                };

                audio.onerror = () => {
                    status.textContent = "Error loading audio. Please try again.";
                    button.disabled = false;
                    isPlaying = false;
                    startStopButton.disabled = false;
                };

                // Add click handler for the play button
                button.onclick = () => {
                    if (audio.paused) {
                        if (recognition && isRecording) {
                            recognition.stop();
                            isRecording = false;
                            updateUI();
                        }
                        isPlaying = true;
                        startStopButton.disabled = true;
                        audio.play();
                    } else {
                        audio.pause();
                        audio.currentTime = 0;
                        isPlaying = false;
                        startStopButton.disabled = false;
                        // Resume recognition if it was previously recording
                        if (!isRecording) {
                            toggleRecording();
                        }
                    }
                };

            } catch (error) {
                status.textContent = "Error: " + error.message;
                button.disabled = false;
                isPlaying = false;
                startStopButton.disabled = false;
            }
        }

        function initializeSpeechRecognition() {
            if ("webkitSpeechRecognition" in window) {
                recognition = new webkitSpeechRecognition();
                setupRecognition();
            } else {
                showError(
                    "আপনার ব্রাউজারে স্পিচ রেকগনিশন সাপোর্টেড নয়। Chrome ব্রাউজার ব্যবহার করুন।"
                );
            }
        }

        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = "bn-BD";

            let buffer = "";
            let lastProcessedLength = 0;
            const sentenceEndMarkers = ['।', '?', '!', '।।'];
            let silenceTimer = null;
            const SILENCE_THRESHOLD = 500;

            recognition.onstart = function() {
                isRecording = true;
                updateUI();
                buffer = "";
                lastProcessedLength = 0;
            };

            recognition.onend = function() {
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
                // Restart recognition if it was stopped but not due to playing audio
                if (!isPlaying && !isRecording) {
                    try {
                        recognition.start();
                    } catch (err) {
                        console.error("Error restarting recognition:", err);
                    }
                }
            };

            recognition.onresult = function(event) {
                let interimTranscript = "";
                let finalTranscript = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        if (silenceTimer) {
                            clearTimeout(silenceTimer);
                        }
                        silenceTimer = setTimeout(() => {
                            handleSentenceCompletion("silence");
                        }, SILENCE_THRESHOLD);
                    } else {
                        interimTranscript += transcript;
                    }
                }

                buffer = finalTranscript || interimTranscript;
                checkForCompletedSentences(buffer.slice(lastProcessedLength));
                lastProcessedLength = buffer.length;

                document.getElementById("result").textContent = 
                    buffer || "আপনার কথা এখানে প্রদর্শিত হবে...";
            };

            function checkForCompletedSentences(newText) {
                if (sentenceEndMarkers.some(marker => newText.includes(marker))) {
                    handleSentenceCompletion("punctuation");
                }
            }

            async function handleSentenceCompletion(reason) {
                const currentText = buffer.trim();
                
                if (currentText) {
                    try {
                        // Create sentence element
                        const completedSentencesDiv = document.getElementById("completedSentences");
                        const sentenceElement = document.createElement("div");
                        sentenceElement.className = "sentence-complete";
                        
                        // Create container for text and controls
                        const container = document.createElement("div");
                        container.className = "sentence-container";
                        
                        // Create text content
                        const textContent = document.createElement("div");
                        textContent.className = "text-content";
                        textContent.textContent = currentText;
                        
                        // Create speech controls
                        const speechElements = createSpeechElements();
                        
                        // Add elements to container
                        container.appendChild(textContent);
                        container.appendChild(speechElements.container);
                        sentenceElement.appendChild(container);
                        
                        // Add to DOM
                        if (completedSentencesDiv.firstChild) {
                            completedSentencesDiv.insertBefore(sentenceElement, completedSentencesDiv.firstChild);
                        } else {
                            completedSentencesDiv.appendChild(sentenceElement);
                        }

                        // Send to backend API
                        const response = await fetch('http://localhost:8000/help_desk_receive/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: currentText,
                                timestamp: new Date().toISOString(),
                                reason: reason,
                                language: 'bn-BD'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(data.agdum);

                        // Setup speech for the response
                        setupSpeech(data.agdum, speechElements);

                    } catch (error) {
                        console.error('Error:', error);
                        const errorSpan = document.createElement('span');
                        errorSpan.className = 'error-message';
                        errorSpan.textContent = ' (পাঠানো ব্যর্থ হয়েছে)';
                        sentenceElement.appendChild(errorSpan);
                    }

                    // Clear buffer if silence-based completion
                    if (reason === "silence") {
                        buffer = "";
                        lastProcessedLength = 0;
                    }
                }
            }

            recognition.onerror = function(event) {
                showError("ত্রুটি: " + event.error);
                isRecording = false;
                updateUI();
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
            };
        }

        function toggleRecording() {
            if (!recognition) {
                initializeSpeechRecognition();
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (err) {
                    showError(
                        "রেকর্ডিং শুরু করতে সমস্যা হচ্ছে। পুনরায় চেষ্টা করুন।"
                    );
                }
            }
        }

        function updateUI() {
            const button = document.getElementById("startStopButton");
            const status = document.getElementById("status");

            if (isRecording) {
                button.textContent = "থামান";
                button.classList.add("recording");
                status.textContent = "রেকর্ডিং চলছে...";
            } else {
                button.textContent = "শুরু করুন";
                button.classList.remove("recording");
                status.textContent = "রেকর্ড করতে বাটনে ক্লিক করুন";
            }

            // Update button state based on audio playback
            button.disabled = isPlaying;
        }

        function showError(message) {
            const status = document.getElementById("status");
            status.textContent = message;
            status.classList.add("error");
        }

        // Add event listener for start/stop button
        document.getElementById("startStopButton").addEventListener("click", toggleRecording);

        // Initialize speech recognition
        initializeSpeechRecognition();
    </script>
</body>
</html>

-->

<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>বাংলা স্পিচ টু টেক্সট - কথোপকথন</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-container {
            margin-top: 20px;
            padding: 20px;
            min-height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            background-color: #fff;
            overflow-y: auto;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
            margin-right: 0;
            text-align: right;
        }

        .server-message {
            background-color: #f5f5f5;
            margin-right: auto;
            margin-left: 0;
            text-align: left;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            min-height: 50px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: left;
            font-size: 16px;
            background-color: #fff;
        }

        #startStopButton {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #startStopButton.recording {
            background-color: #f44336;
        }

        #startStopButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .error {
            color: #f44336;
            margin-top: 10px;
        }

        .play-button {
            background: none;
            border: none;
            color: #4caf50;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .play-button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .audio-player {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>বাংলা স্পিচ টু টেক্সট - কথোপকথন</h1>
        <button id="startStopButton">শুরু করুন</button>
        <p class="status" id="status">রেকর্ড করতে বাটনে ক্লিক করুন</p>
        
        <div id="result">আপনার বর্তমান কথা: ...</div>
        
        <div class="chat-container" id="chatContainer">
            <!-- Messages will be added here dynamically -->
        </div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;
        let isPlaying = false;
        let currentAudio = null;
        const startStopButton = document.getElementById("startStopButton");
        const chatContainer = document.getElementById("chatContainer");

        function addMessage(text, isUser = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'server-message'}`;
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            messageDiv.appendChild(textSpan);

            if (!isUser) {
                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.innerHTML = '🔊';
                playButton.onclick = () => speak(text);
                messageDiv.appendChild(playButton);
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function speak(text) {
            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }

            // Create new audio element
            const audio = new Audio();
            currentAudio = audio;
            
            // Generate Google Translate TTS URL
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=bn&client=tw-ob&q=${encodeURIComponent(text)}`;
            audio.src = url;
            
            // Stop recording while speaking
            if (recognition && isRecording) {
                recognition.stop();
                isRecording = false;
                updateUI();
            }

            audio.onended = () => {
                isPlaying = false;
                startStopButton.disabled = false;
                // Resume recording if it was previously recording
                if (!isRecording) {
                    toggleRecording();
                }
                currentAudio = null;
            };

            audio.onplay = () => {
                isPlaying = true;
                startStopButton.disabled = true;
            };

            audio.onerror = (error) => {
                console.error('Audio playback error:', error);
                isPlaying = false;
                startStopButton.disabled = false;
                currentAudio = null;
            };

            // Play the audio
            audio.play().catch(error => {
                console.error('Error playing audio:', error);
                isPlaying = false;
                startStopButton.disabled = false;
                currentAudio = null;
            });
        }

        function initializeSpeechRecognition() {
            if ("webkitSpeechRecognition" in window) {
                recognition = new webkitSpeechRecognition();
                setupRecognition();
            } else {
                showError(
                    "আপনার ব্রাউজারে স্পিচ রেকগনিশন সাপোর্টেড নয়। Chrome ব্রাউজার ব্যবহার করুন।"
                );
            }
        }

        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = "bn-BD";

            recognition.onstart = function() {
                isRecording = true;
                updateUI();
            };

            recognition.onend = function() {
                isRecording = false;
                updateUI();
                // Restart recognition if it was stopped but not due to playing audio
                if (!isPlaying && !isRecording) {
                    try {
                        recognition.start();
                    } catch (err) {
                        console.error("Error restarting recognition:", err);
                    }
                }
            };

            recognition.onresult = function(event) {
                let interimTranscript = "";
                let finalTranscript = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        handleSentenceCompletion(transcript);
                    } else {
                        interimTranscript += transcript;
                    }
                }

                document.getElementById("result").textContent = 
                    "আপনার বর্তমান কথা: " + (finalTranscript || interimTranscript || "...");
            };

            async function handleSentenceCompletion(text) {
                if (!text.trim()) return;

                // Add user message to chat
                addMessage(text, true);

                try {
                    // Send to backend API
                    const response = await fetch('http://localhost:8000/help_desk_receive/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            timestamp: new Date().toISOString(),
                            language: 'bn-BD'
                        })
                    });

                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    
                    // Add server response to chat
                    addMessage(data.agdum, false);
                    
                    // Automatically speak the response
                    speak(data.agdum);

                } catch (error) {
                    console.error('Error:', error);
                    showError("সার্ভারের সাথে যোগাযোগ করতে সমস্যা হচ্ছে");
                }
            }

            recognition.onerror = function(event) {
                showError("ত্রুটি: " + event.error);
                isRecording = false;
                updateUI();
            };
        }

        function toggleRecording() {
            if (!recognition) {
                initializeSpeechRecognition();
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (err) {
                    showError(
                        "রেকর্ডিং শুরু করতে সমস্যা হচ্ছে। পুনরায় চেষ্টা করুন।"
                    );
                }
            }
        }

        function updateUI() {
            const button = document.getElementById("startStopButton");
            const status = document.getElementById("status");

            if (isRecording) {
                button.textContent = "থামান";
                button.classList.add("recording");
                status.textContent = "রেকর্ডিং চলছে...";
            } else {
                button.textContent = "শুরু করুন";
                button.classList.remove("recording");
                status.textContent = "রেকর্ড করতে বাটনে ক্লিক করুন";
            }

            button.disabled = isPlaying;
        }

        function showError(message) {
            const status = document.getElementById("status");
            status.textContent = message;
            status.classList.add("error");
        }

        // Add event listener for start/stop button
        document.getElementById("startStopButton").addEventListener("click", toggleRecording);

        // Initialize speech recognition
        initializeSpeechRecognition();
    </script>
</body>
</html>
